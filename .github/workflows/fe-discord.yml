name: Discord Notifications

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, labeled, closed]
  pull_request_review:
    types: [submitted]

env:
  hwinkr: "@í•´ë¦¬"
  useon: "@ì¬ë°ì´"

jobs:
  notify_issue:
    runs-on: ubuntu-latest

    steps:
      - name: ìƒˆë¡œìš´ ì´ìŠˆê°€ ë“±ë¡ë˜ë©´ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
        if: github.event.issue && contains(github.event.issue.title, '[FE]')
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          ASSIGNEES=$(jq -r '.issue.assignees | map(.login) | join(", ")' < $GITHUB_EVENT_PATH)
          ASSIGNEES_MAPPED=$(jq -r --argjson env "$(jq -n env)" '.issue.assignees | map(.login) | map($env[.] // .) | join(", ")' < $GITHUB_EVENT_PATH)
          LABELS=$(jq -r '.issue.labels | map(.name) | join(", ")' < $GITHUB_EVENT_PATH)
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"ğŸ€ ìƒˆë¡œìš´ ì´ìŠˆê°€ ë“±ë¡ë˜ì—ˆì–´ìš”! ğŸ§š: ${{ github.event.issue.html_url }}\n
                                ğŸ“‚ ì œëª©: ${{ github.event.issue.title }}\n
                                ğŸ‘¨ğŸ»â€ğŸ« ì„¤ëª…: ${{ github.event.issue.body }}\n
                                ğŸ•º í• ë‹¹ëœ ì‚¬ìš©ì: ${ASSIGNEES_MAPPED}\n
                                ğŸ·ï¸ ë¼ë²¨: ${LABELS}\"}" \
          $DISCORD_WEBHOOK_URL

  notify_pr:
    runs-on: ubuntu-latest

    steps:
      - name: ìƒˆë¡œìš´ PRì´ ë“±ë¡ë˜ë©´ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
        if: github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[FE]')
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"New frontend PR opened: ${{ github.event.pull_request.html_url }}\"}" \
          $DISCORD_WEBHOOK_URL

  notify_review:
    runs-on: ubuntu-latest

    steps:
      - name: ìƒˆë¡œìš´ ë¦¬ë·°ê°€ ë“±ë¡ë˜ë©´ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
        if: contains(github.event.pull_request.labels.*.name, 'í”„ë¡ íŠ¸ì—”ë“œ') && github.event.review && (github.event.review.user.login == env.harry || github.event.review.user.login == env.ssunday)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "Pull request labels: ${{ toJson(github.event.pull_request.labels) }}"
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"New review submitted for PR by ${{ github.event.review.user.login }}: ${{ github.event.pull_request.html_url }}\"}" \
          $DISCORD_WEBHOOK_URL

  notify_merge:
    runs-on: ubuntu-latest

    steps:
      - name: í’€ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ë¨¸ì§€ë˜ë©´ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"PR merged: ${{ github.event.pull_request.html_url }}\"}" \
          $DISCORD_WEBHOOK_URL
